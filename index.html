<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Rajnandini Sales Dashboard – Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Flatpickr (single + range) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg: #f3f4f6;           /* page background */
      --bg-card: #ffffff;      /* panels/cards */
      --border: #e5e7eb;
      --border-soft: #d1d5db;
      --text-main: #111827;    /* main text */
      --text-muted: #6b7280;   /* secondary text */
      --accent: #c9a86a;       /* gold */
      --accent-dark: #013c47;  /* teal */
    }
    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text-main);
    }

    header {
      padding: 16px 24px;
      background: #ffffff;
      border-bottom: 3px solid var(--accent);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 16px;
    }
    header img {
      height: 48px;
      object-fit: contain;
      background: transparent;
    }
    .header-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .header-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--accent-dark);
    }
    .header-tagline {
      font-size: 0.8rem;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: .16em;
    }
    .header-sub {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .info-bar {
      padding: 10px 24px;
      background: #ffffff;
      border-bottom: 1px solid var(--border);
      font-size: 0.78rem;
      color: var(--text-muted);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: space-between;
      align-items: center;
    }

    .filters-bar {
      padding: 10px 24px 14px;
      background: #ffffff;
      border-bottom: 1px solid var(--border);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
      gap: 10px;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.8rem;
    }
    .filter-group label {
      color: var(--text-muted);
    }
    .filter-group input,
    .filter-group select {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: #ffffff;
      color: var(--text-main);
      font-size: 0.8rem;
    }

    .container {
      padding: 16px 24px 32px;
      max-width: 1400px;
      margin: 0 auto;
    }
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 14px 16px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 12px rgba(15,23,42,0.08);
    }
    .card-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    .card-value {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--accent-dark);
    }
    .card-sub {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0,1fr);
      gap: 20px;
    }
    @media (min-width: 1024px) {
      .grid-2 {
        grid-template-columns: minmax(0,1.1fr) minmax(0,1fr);
      }
    }

    .panel {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 14px 16px 10px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 16px rgba(15,23,42,0.08);
    }
    .panel-header {
      margin-bottom: 6px;
    }
    .panel-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-main);
    }
    .panel-subtitle {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    .panel-underline {
      height: 2px;
      width: 40px;
      background: var(--accent);
      border-radius: 999px;
      margin-top: 4px;
      margin-bottom: 4px;
    }

    canvas {
      width: 100% !important;
      height: 260px !important;
    }

    .table-wrapper {
      max-height: 260px;
      overflow: auto;
      border-radius: 10px;
      border: 1px solid var(--border);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      background: #ffffff;
    }
    thead {
      position: sticky;
      top: 0;
      background: #f9fafb;
      z-index: 1;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      white-space: nowrap;
    }
    th {
      text-align: left;
      font-weight: 500;
      color: var(--text-muted);
    }
    tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    footer {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-align: right;
      padding: 8px 24px 12px;
      border-top: 2px solid var(--accent);
      background: #ffffff;
    }
  </style>
</head>
<body>
<header>
  <img src="assets/logo.png" alt="Rajnandini Logo">
  <div class="header-text">
    <div class="header-title">Rajnandini Fashion India Ltd.</div>
    <div class="header-tagline">A Style Of Every Story</div>
    <div class="header-sub">Multi-Channel Sales Performance Dashboard – Viewer</div>
  </div>
</header>

<div class="info-bar">
  <div id="infoStatus">Loading published report...</div>
  <div id="infoGeneratedAt"></div>
</div>

<div class="filters-bar">
  <div class="filter-group">
    <label for="dateRange">Date / Date Range</label>
    <input type="text" id="dateRange" placeholder="Select date or range" />
  </div>
  <div class="filter-group">
    <label for="channelFilter">Channel (Platform)</label>
    <select id="channelFilter">
      <option value="ALL">All Channels</option>
    </select>
  </div>
  <div class="filter-group">
    <label for="accountFilter">Account</label>
    <select id="accountFilter">
      <option value="ALL">All Accounts</option>
    </select>
  </div>
</div>

<div class="container">
  <!-- Summary cards -->
  <div class="cards">
    <div class="card">
      <div class="card-title">Gross Revenue</div>
      <div class="card-value" id="grossRevenue">₹0</div>
      <div class="card-sub">Sum of Selling Price (all orders)</div>
    </div>
    <div class="card">
      <div class="card-title">Gross Units</div>
      <div class="card-value" id="grossUnits">0</div>
      <div class="card-sub">Count of rows (each row = 1 unit)</div>
    </div>
    <div class="card">
      <div class="card-title">Total Orders</div>
      <div class="card-value" id="totalOrders">0</div>
      <div class="card-sub">Number of order lines</div>
    </div>
    <div class="card">
      <div class="card-title">Cancellation Rate</div>
      <div class="card-value" id="cancelRate">0%</div>
      <div class="card-sub">Cancelled / All orders</div>
    </div>
  </div>

  <!-- Revenue by Channel & Account -->
  <div class="grid grid-2">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Revenue by Channel (Platform)</div>
        <div class="panel-subtitle">Aggregated by marketplace platform</div>
        <div class="panel-underline"></div>
      </div>
      <canvas id="channelRevenueChart"></canvas>
    </div>

    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Revenue by Account</div>
        <div class="panel-subtitle">Mapped from Channel → Account</div>
        <div class="panel-underline"></div>
      </div>
      <canvas id="accountRevenueChart"></canvas>
    </div>
  </div>

  <!-- Status + Revenue Trend -->
  <div class="grid grid-2" style="margin-top:20px;">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Order Status Breakdown</div>
        <div class="panel-subtitle">Delivered / Cancelled / Returned / Others</div>
        <div class="panel-underline"></div>
      </div>
      <canvas id="statusChart"></canvas>
    </div>

    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Revenue Trend by Date</div>
        <div class="panel-subtitle">Based on Order Date</div>
        <div class="panel-underline"></div>
      </div>
      <canvas id="dateRevenueChart"></canvas>
    </div>
  </div>

  <!-- Revenue by State -->
  <div class="grid" style="margin-top:20px;">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Revenue by State</div>
        <div class="panel-subtitle">Shipping Address State</div>
        <div class="panel-underline"></div>
      </div>
      <canvas id="stateRevenueChart"></canvas>
    </div>
  </div>

  <!-- Price range & Top styles -->
  <div class="grid grid-2" style="margin-top:20px;">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Price Range Distribution</div>
        <div class="panel-subtitle">Which price bands drive most orders</div>
        <div class="panel-underline"></div>
      </div>
      <div class="table-wrapper">
        <table id="priceRangeTable">
          <thead>
          <tr>
            <th>Price Range (₹)</th>
            <th>Orders</th>
            <th>Revenue (₹)</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Top 10 Styles (Delivered)</div>
        <div class="panel-subtitle">By GMV – style code from SKU</div>
        <div class="panel-underline"></div>
      </div>
      <div class="table-wrapper">
        <table id="topStylesTable">
          <thead>
          <tr>
            <th>Style Code</th>
            <th>Units Sold</th>
            <th>GMV (₹)</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Channel & Account summary -->
  <div class="grid" style="margin-top:20px;">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Channel & Account Summary</div>
        <div class="panel-subtitle">Sorted by Revenue (highest first)</div>
        <div class="panel-underline"></div>
      </div>
      <div class="table-wrapper">
        <table id="channelTable">
          <thead>
          <tr>
            <th>Platform</th>
            <th>Account</th>
            <th>Revenue (₹)</th>
            <th>Units</th>
            <th>Orders</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<footer>
  © Rajnandini Fashion India Ltd. | FOR INTERNAL USE ONLY
</footer>

<script>
  let normalizedRows = [];
  let charts = {
    channelRevenueChart: null,
    accountRevenueChart: null,
    stateRevenueChart: null,
    statusChart: null,
    dateRevenueChart: null
  };

  const infoStatusEl    = document.getElementById('infoStatus');
  const infoGeneratedEl = document.getElementById('infoGeneratedAt');

  const dateRangeInput  = document.getElementById('dateRange');
  const channelFilterEl = document.getElementById('channelFilter');
  const accountFilterEl = document.getElementById('accountFilter');

  const grossRevenueEl  = document.getElementById('grossRevenue');
  const grossUnitsEl    = document.getElementById('grossUnits');
  const totalOrdersEl   = document.getElementById('totalOrders');
  const cancelRateEl    = document.getElementById('cancelRate');

  let dateRange = { start: null, end: null };

  // Flatpickr for viewer
  flatpickr(dateRangeInput, {
    mode: "range",
    dateFormat: "Y-m-d",
    onChange: function(selectedDates) {
      if (selectedDates.length === 0) {
        dateRange.start = null;
        dateRange.end   = null;
      } else if (selectedDates.length === 1) {
        dateRange.start = selectedDates[0];
        dateRange.end   = null;
      } else {
        const [d1, d2] = selectedDates;
        dateRange.start = d1 < d2 ? d1 : d2;
        dateRange.end   = d1 < d2 ? d2 : d1;
      }
      if (normalizedRows.length) applyFiltersAndRender();
    }
  });

  channelFilterEl.addEventListener('change', applyFiltersAndRender);
  accountFilterEl.addEventListener('change', applyFiltersAndRender);

  function dateToIsoString(d) {
    if (!d) return null;
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  function buildFilterOptions(rows) {
    const platforms = new Set();
    const accounts  = new Set();
    rows.forEach(r => {
      if (r.platform) platforms.add(r.platform);
      if (r.account)  accounts.add(r.account);
    });

    channelFilterEl.innerHTML = '<option value="ALL">All Channels</option>';
    Array.from(platforms).sort().forEach(p => {
      const opt = document.createElement('option');
      opt.value = p;
      opt.textContent = p;
      channelFilterEl.appendChild(opt);
    });

    accountFilterEl.innerHTML = '<option value="ALL">All Accounts</option>';
    Array.from(accounts).sort().forEach(a => {
      const opt = document.createElement('option');
      opt.value = a;
      opt.textContent = a;
      accountFilterEl.appendChild(opt);
    });
  }

  function applyFiltersAndRender() {
    if (!normalizedRows.length) return;

    const selectedPlatform = channelFilterEl.value || 'ALL';
    const selectedAccount  = accountFilterEl.value || 'ALL';
    const startIso = dateToIsoString(dateRange.start);
    const endIso   = dateToIsoString(dateRange.end);

    const filtered = normalizedRows.filter(r => {
      if (startIso && !endIso) {
        if (!r.date_iso || r.date_iso !== startIso) return false;
      } else if (startIso && endIso) {
        if (!r.date_iso || r.date_iso < startIso || r.date_iso > endIso) return false;
      }
      if (selectedPlatform !== 'ALL' && r.platform !== selectedPlatform) return false;
      if (selectedAccount  !== 'ALL' && r.account  !== selectedAccount)  return false;
      return true;
    });

    infoStatusEl.textContent = `Filtered rows: ${filtered.length}`;
    processAndRender(filtered);
  }

  function processAndRender(rows) {
    let grossRevenue = 0;
    let grossUnits   = rows.length;
    let totalOrders  = rows.length;
    let cancelledCount = 0;

    const revenueByChannel = {};
    const revenueByAccount = {};
    const revenueByState   = {};
    const statusCounts     = {};
    const revenueByDate    = {};
    const summaryByPlatformAccount = {};

    const priceBuckets = {
      '<500':      { label: '< 500',       orders: 0, revenue: 0 },
      '500-749':   { label: '500 – 749',   orders: 0, revenue: 0 },
      '750-999':   { label: '750 – 999',   orders: 0, revenue: 0 },
      '1000-1499': { label: '1000 – 1499', orders: 0, revenue: 0 },
      '1500+':     { label: '≥ 1500',      orders: 0, revenue: 0 }
    };

    const styleStats = {}; // style_code → { style_code, units, gmv }

    rows.forEach(r => {
      const price = r.price || 0;
      grossRevenue += price;

      if (r.status_logical === 'CANCELLED') cancelledCount += 1;

      const statusKey = r.status_logical || 'UNKNOWN';
      statusCounts[statusKey] = (statusCounts[statusKey] || 0) + 1;

      const platform = r.platform || 'Unknown';
      const account  = r.account  || 'Unknown';
      const state    = r.state    || 'Unknown';

      revenueByChannel[platform] = (revenueByChannel[platform] || 0) + price;
      revenueByAccount[account]  = (revenueByAccount[account]  || 0) + price;
      revenueByState[state]      = (revenueByState[state]      || 0) + price;

      const dateKey = r.date_iso || 'Unknown';
      revenueByDate[dateKey] = (revenueByDate[dateKey] || 0) + price;

      const key = platform + '||' + account;
      if (!summaryByPlatformAccount[key]) {
        summaryByPlatformAccount[key] = { platform, account, revenue: 0, units: 0, orders: 0 };
      }
      summaryByPlatformAccount[key].revenue += price;
      summaryByPlatformAccount[key].units   += 1;
      summaryByPlatformAccount[key].orders  += 1;

      let bucketKey;
      if (price < 500)            bucketKey = '<500';
      else if (price < 750)       bucketKey = '500-749';
      else if (price < 1000)      bucketKey = '750-999';
      else if (price < 1500)      bucketKey = '1000-1499';
      else                        bucketKey = '1500+';

      priceBuckets[bucketKey].orders  += 1;
      priceBuckets[bucketKey].revenue += price;

      if (r.status_logical === 'DELIVERED' && r.style_code) {
        const style = r.style_code;
        if (!styleStats[style]) {
          styleStats[style] = { style_code: style, units: 0, gmv: 0 };
        }
        styleStats[style].units += 1;
        styleStats[style].gmv   += price;
      }
    });

    grossRevenueEl.textContent = '₹' + grossRevenue.toLocaleString('en-IN', { maximumFractionDigits: 2 });
    grossUnitsEl.textContent   = grossUnits.toLocaleString('en-IN');
    totalOrdersEl.textContent  = totalOrders.toLocaleString('en-IN');
    const cancelRate = totalOrders ? (cancelledCount / totalOrders) * 100 : 0;
    cancelRateEl.textContent   = cancelRate.toFixed(1) + '%';

    buildChannelRevenueChart(revenueByChannel);
    buildAccountRevenueChart(revenueByAccount);
    buildStateRevenueChart(revenueByState);
    buildStatusChart(statusCounts);
    buildDateRevenueChart(revenueByDate);
    buildChannelTable(summaryByPlatformAccount);
    buildPriceRangeTable(priceBuckets);
    buildTopStylesTable(styleStats);
  }

  function destroyChart(chart) {
    if (chart) chart.destroy();
  }

  function buildChannelRevenueChart(revenueByChannel) {
    const ctx = document.getElementById('channelRevenueChart');
    destroyChart(charts.channelRevenueChart);

    const labels = Object.keys(revenueByChannel);
    const data   = labels.map(l => revenueByChannel[l]);

    charts.channelRevenueChart = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: 'Revenue (₹)', data }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (ctx) => '₹' + ctx.raw.toLocaleString('en-IN', { maximumFractionDigits: 2 })
            }
          }
        },
        scales: {
          x: { ticks: { font: { size: 10 }, color: '#4b5563' } },
          y: {
            ticks: {
              color: '#4b5563',
              callback: (val) => '₹' + Number(val).toLocaleString('en-IN')
            }
          }
        }
      }
    });
  }

  function buildAccountRevenueChart(revenueByAccount) {
    const ctx = document.getElementById('accountRevenueChart');
    destroyChart(charts.accountRevenueChart);

    const labels = Object.keys(revenueByAccount);
    const data   = labels.map(l => revenueByAccount[l]);

    charts.accountRevenueChart = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: 'Revenue (₹)', data }] },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (ctx) => '₹' + ctx.raw.toLocaleString('en-IN', { maximumFractionDigits: 2 })
            }
          }
        },
        scales: {
          x: {
            ticks: {
              color: '#4b5563',
              callback: (val) => '₹' + Number(val).toLocaleString('en-IN')
            }
          },
          y: { ticks: { font: { size: 10 }, color: '#4b5563' } }
        }
      }
    });
  }

  function buildStateRevenueChart(revenueByState) {
    const ctx = document.getElementById('stateRevenueChart');
    destroyChart(charts.stateRevenueChart);

    const entries = Object.entries(revenueByState).sort((a, b) => b[1] - a[1]);
    const labels  = entries.map(e => e[0]);
    const data    = entries.map(e => e[1]);

    charts.stateRevenueChart = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: 'Revenue (₹)', data }] },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (ctx) => '₹' + ctx.raw.toLocaleString('en-IN', { maximumFractionDigits: 2 })
            }
          }
        },
        scales: {
          x: {
            ticks: {
              color: '#4b5563',
              callback: (val) => '₹' + Number(val).toLocaleString('en-IN')
            }
          },
          y: { ticks: { font: { size: 10 }, color: '#4b5563' } }
        }
      }
    });
  }

  function buildStatusChart(statusCounts) {
    const ctx = document.getElementById('statusChart');
    destroyChart(charts.statusChart);

    const labels = Object.keys(statusCounts);
    const data   = labels.map(l => statusCounts[l]);

    charts.statusChart = new Chart(ctx, {
      type: 'pie',
      data: { labels, datasets: [{ data }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: { font: { size: 10 }, color: '#4b5563' }
          }
        }
      }
    });
  }

  function buildDateRevenueChart(revenueByDate) {
    const ctx = document.getElementById('dateRevenueChart');
    destroyChart(charts.dateRevenueChart);

    const entries = Object.entries(revenueByDate)
      .filter(([k]) => k && k !== 'Unknown')
      .sort((a, b) => (a[0] > b[0] ? 1 : -1));

    const labels = entries.map(e => e[0]);
    const data   = entries.map(e => e[1]);

    charts.dateRevenueChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Revenue (₹)',
          data,
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (ctx) => '₹' + ctx.raw.toLocaleString('en-IN', { maximumFractionDigits: 2 })
            }
          }
        },
        scales: {
          x: {
            ticks: { maxRotation: 60, minRotation: 30, font: { size: 9 }, color: '#4b5563' }
          },
          y: {
            ticks: {
              color: '#4b5563',
              callback: (val) => '₹' + Number(val).toLocaleString('en-IN')
            }
          }
        }
      }
    });
  }

  function buildChannelTable(summaryByPlatformAccount) {
    const tbody = document.querySelector('#channelTable tbody');
    tbody.innerHTML = '';

    const rows = Object.values(summaryByPlatformAccount)
      .sort((a, b) => b.revenue - a.revenue); // HIGH to LOW revenue

    rows.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.platform}</td>
        <td>${r.account}</td>
        <td>₹${r.revenue.toLocaleString('en-IN', { maximumFractionDigits: 2 })}</td>
        <td>${r.units}</td>
        <td>${r.orders}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function buildPriceRangeTable(priceBuckets) {
    const tbody = document.querySelector('#priceRangeTable tbody');
    tbody.innerHTML = '';

    const rows = Object.values(priceBuckets)
      .map(b => ({
        label: b.label,
        orders: b.orders,
        revenue: b.revenue
      }))
      .sort((a, b) => b.orders - a.orders || b.revenue - a.revenue);

    rows.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.label}</td>
        <td>${r.orders.toLocaleString('en-IN')}</td>
        <td>₹${r.revenue.toLocaleString('en-IN', { maximumFractionDigits: 2 })}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function buildTopStylesTable(styleStats) {
    const tbody = document.querySelector('#topStylesTable tbody');
    tbody.innerHTML = '';

    const rows = Object.values(styleStats)
      .sort((a, b) => b.gmv - a.gmv)
      .slice(0, 10);

    rows.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.style_code}</td>
        <td>${r.units.toLocaleString('en-IN')}</td>
        <td>₹${r.gmv.toLocaleString('en-IN', { maximumFractionDigits: 2 })}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ---- Load report-data.json published by admin ----
  fetch('data/report-data.json?_=' + Date.now())
    .then(resp => {
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      return resp.json();
    })
    .then(json => {
      normalizedRows = json.rows || [];
      if (!normalizedRows.length) {
        infoStatusEl.textContent = 'Published report loaded, but contains 0 rows.';
      } else {
        infoStatusEl.textContent = `Loaded published report with ${normalizedRows.length} rows.`;
      }
      if (json.generated_at) {
        infoGeneratedEl.textContent = 'Generated at: ' + json.generated_at;
      }
      buildFilterOptions(normalizedRows);
      applyFiltersAndRender();
    })
    .catch(err => {
      console.error(err);
      infoStatusEl.textContent = 'No published report found or error loading it.';
      infoGeneratedEl.textContent = '';
    });
</script>
</body>
</html>
