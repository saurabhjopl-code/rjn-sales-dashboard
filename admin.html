<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Rajnandini Admin – Sales Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Flatpickr (single + range date picker in one input) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- PapaParse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      --bg: #f3f4f6;           /* page background */
      --bg-card: #ffffff;      /* panels/cards */
      --border: #e5e7eb;
      --border-soft: #d1d5db;
      --text-main: #111827;    /* main text */
      --text-muted: #6b7280;   /* secondary text */
      --accent: #c9a86a;       /* gold */
      --accent-dark: #013c47;  /* teal */
    }
    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text-main);
    }

    header {
      padding: 16px 24px;
      background: #ffffff;
      border-bottom: 3px solid var(--accent);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 16px;
    }
    header img {
      height: 48px;
      object-fit: contain;
      background: transparent;
    }
    .header-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .header-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--accent-dark);
    }
    .header-tagline {
      font-size: 0.8rem;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: .16em;
    }
    .header-sub {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .upload-area {
      padding: 12px 24px;
      background: #ffffff;
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .upload-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
    }
    .upload-area input[type="file"] {
      padding: 6px 8px;
      background: #ffffff;
      border: 1px solid var(--border-soft);
      border-radius: 8px;
      color: var(--text-main);
      font-size: 0.8rem;
    }
    .btn {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #f9fafb;
      color: var(--text-main);
      font-size: 0.8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn:hover:not(:disabled) {
      background: #e5e7eb;
    }
    .btn-primary {
      background: var(--accent-dark);
      border-color: var(--accent-dark);
      color: #ffffff;
    }
    .btn-primary:hover:not(:disabled) {
      background: #012833;
    }
    .btn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }
    .upload-status {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .filters-bar {
      padding: 10px 24px 14px;
      background: #ffffff;
      border-bottom: 1px solid var(--border);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
      gap: 10px;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.8rem;
    }
    .filter-group label {
      color: var(--text-muted);
    }
    .filter-group input,
    .filter-group select {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: #ffffff;
      color: var(--text-main);
      font-size: 0.8rem;
    }

    .container {
      padding: 16px 24px 32px;
      max-width: 1400px;
      margin: 0 auto;
    }
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 14px 16px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 12px rgba(15,23,42,0.08);
    }
    .card-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    .card-value {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--accent-dark);
    }
    .card-sub {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0,1fr);
      gap: 20px;
    }
    @media (min-width: 1024px) {
      .grid-2 {
        grid-template-columns: minmax(0,1.1fr) minmax(0,1fr);
      }
    }

    .panel {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 14px 16px 10px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 16px rgba(15,23,42,0.08);
    }
    .panel-header {
      margin-bottom: 6px;
    }
    .panel-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-main);
    }
    .panel-subtitle {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    .panel-underline {
      height: 2px;
      width: 40px;
      background: var(--accent);
      border-radius: 999px;
      margin-top: 4px;
      margin-bottom: 4px;
    }

    canvas {
      width: 100% !important;
      height: 260px !important;
    }

    .table-wrapper {
      max-height: 260px;
      overflow: auto;
      border-radius: 10px;
      border: 1px solid var(--border);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      background: #ffffff;
    }
    thead {
      position: sticky;
      top: 0;
      background: #f9fafb;
      z-index: 1;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      white-space: nowrap;
    }
    th {
      text-align: left;
      font-weight: 500;
      color: var(--text-muted);
    }
    tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    footer {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-align: right;
      padding: 8px 24px 12px;
      border-top: 2px solid var(--accent);
      background: #ffffff;
    }

    /* India map specific */
    #indiaMapWrapper {
      width: 100%;
      height: 260px;
      position: relative;
      overflow: hidden;
    }
    #indiaMapWrapper svg {
      width: 100%;
      height: 100%;
    }
    #indiaMapLegend {
      margin-top: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.7rem;
      color: var(--text-muted);
      flex-wrap: wrap;
    }
    .legend-blocks {
      display: inline-flex;
      align-items: center;
      gap: 2px;
    }
    .legend-color {
      width: 14px;
      height: 10px;
      border-radius: 3px;
      border: 1px solid #d1d5db;
    }
    #indiaMapTooltip {
      position: fixed;
      pointer-events: none;
      background: #ffffff;
      border: 1px solid #d1d5db;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.75rem;
      color: var(--text-main);
      box-shadow: 0 4px 12px rgba(0,0,0,0.16);
      display: none;
      z-index: 9999;
    }
  </style>
</head>
<body>
<header>
  <img src="assets/logo.png" alt="Rajnandini Logo">
  <div class="header-text">
    <div class="header-title">Rajnandini Fashion India Ltd.</div>
    <div class="header-tagline">A Style Of Every Story</div>
    <div class="header-sub">Multi-Channel Sales Performance Dashboard – Admin Panel</div>
  </div>
</header>

<div class="upload-area">
  <div class="upload-row">
    <label for="fileInput"><strong>Upload Orders CSV:</strong></label>
    <input type="file" id="fileInput" accept=".csv" />
    <button type="button" id="sampleHintBtn" class="btn">CSV Format Help</button>
    <button type="button" id="generateBtn" class="btn btn-primary" disabled>Generate Report</button>
    <button type="button" id="publishBtn" class="btn" disabled>Send to Viewer</button>
    <span id="fileStatus" class="upload-status"></span>
  </div>

  <!-- GitHub token input -->
  <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:4px;font-size:0.8rem;">
    <label for="githubTokenInput">GitHub Token (stored only in this browser):</label>
    <input
      type="password"
      id="githubTokenInput"
      placeholder="Paste github_pat_..."
      style="padding:4px 8px;border-radius:6px;border:1px solid #d1d5db;background:#ffffff;color:#111827;min-width:260px;"
    />
    <button type="button" id="saveTokenBtn" class="btn">Save Token</button>
    <span id="tokenStatus" style="color:var(--text-muted);"></span>
  </div>
</div>

<div class="filters-bar">
  <div class="filter-group">
    <label for="dateRange">Date / Date Range</label>
    <input type="text" id="dateRange" placeholder="Select date or range" />
  </div>
  <div class="filter-group">
    <label for="channelFilter">Channel (Platform)</label>
    <select id="channelFilter">
      <option value="ALL">All Channels</option>
    </select>
  </div>
  <div class="filter-group">
    <label for="accountFilter">Account</label>
    <select id="accountFilter">
      <option value="ALL">All Accounts</option>
    </select>
  </div>
</div>

<div class="container">
  <div class="cards">
    <div class="card">
      <div class="card-title">Gross Revenue</div>
      <div class="card-value" id="grossRevenue">₹0</div>
      <div class="card-sub">Sum of Selling Price (all orders)</div>
    </div>
    <div class="card">
      <div class="card-title">Gross Units</div>
      <div class="card-value" id="grossUnits">0</div>
      <div class="card-sub">Count of rows (each row = 1 unit)</div>
    </div>
    <div class="card">
      <div class="card-title">Total Orders</div>
      <div class="card-value" id="totalOrders">0</div>
      <div class="card-sub">Number of order lines</div>
    </div>
    <div class="card">
      <div class="card-title">Cancellation Rate</div>
      <div class="card-value" id="cancelRate">0%</div>
      <div class="card-sub">Cancelled / All orders</div>
    </div>
  </div>

  <!-- Revenue by Channel & Account -->
  <div class="grid grid-2">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Revenue by Channel (Platform)</div>
        <div class="panel-subtitle">Aggregated by marketplace platform</div>
        <div class="panel-underline"></div>
      </div>
      <canvas id="channelRevenueChart"></canvas>
    </div>

    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Revenue by Account</div>
        <div class="panel-subtitle">Mapped from Channel → Account</div>
        <div class="panel-underline"></div>
      </div>
      <canvas id="accountRevenueChart"></canvas>
    </div>
  </div>

  <!-- India map + Status side-by-side -->
  <div class="grid grid-2" style="margin-top:20px;">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">India Heatmap – Revenue by State/UT</div>
        <div class="panel-subtitle">Shipping Address State / Union Territory</div>
        <div class="panel-underline"></div>
      </div>
      <div id="indiaMapWrapper">
        <!-- india.svg will be injected here -->
      </div>
      <div id="indiaMapLegend"></div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Order Status Breakdown</div>
        <div class="panel-subtitle">Delivered / Cancelled / Returned / Others</div>
        <div class="panel-underline"></div>
      </div>
      <canvas id="statusChart"></canvas>
    </div>
  </div>

  <!-- Revenue by State bar chart -->
  <div class="grid" style="margin-top:20px;">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Revenue by State</div>
        <div class="panel-subtitle">Shipping Address State</div>
        <div class="panel-underline"></div>
      </div>
      <canvas id="stateRevenueChart"></canvas>
    </div>
  </div>

  <!-- Revenue trend -->
  <div class="grid" style="margin-top:20px;">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Revenue Trend by Date</div>
        <div class="panel-subtitle">Based on Order Date</div>
        <div class="panel-underline"></div>
      </div>
      <canvas id="dateRevenueChart"></canvas>
    </div>
  </div>

  <!-- Price range & Top styles -->
  <div class="grid grid-2" style="margin-top:20px;">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Price Range Distribution</div>
        <div class="panel-subtitle">Which price bands drive most orders</div>
        <div class="panel-underline"></div>
      </div>
      <div class="table-wrapper">
        <table id="priceRangeTable">
          <thead>
          <tr>
            <th>Price Range (₹)</th>
            <th>Orders</th>
            <th>Revenue (₹)</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Top 10 Styles (Delivered)</div>
        <div class="panel-subtitle">By GMV – style code from SKU</div>
        <div class="panel-underline"></div>
      </div>
      <div class="table-wrapper">
        <table id="topStylesTable">
          <thead>
          <tr>
            <th>Style Code</th>
            <th>Units Sold</th>
            <th>GMV (₹)</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Channel & Account summary -->
  <div class="grid" style="margin-top:20px;">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Channel & Account Summary</div>
        <div class="panel-subtitle">Sorted by Revenue (highest first)</div>
        <div class="panel-underline"></div>
      </div>
      <div class="table-wrapper">
        <table id="channelTable">
          <thead>
          <tr>
            <th>Platform</th>
            <th>Account</th>
            <th>Revenue (₹)</th>
            <th>Units</th>
            <th>Orders</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<footer>
  © Rajnandini Fashion India Ltd. | FOR INTERNAL USE ONLY
</footer>

<div id="indiaMapTooltip"></div>

<script>
  // ---------- GitHub publish config ----------
  const GH_OWNER = 'saurabhjopl-code';
  const GH_REPO = 'rjn-sales-dashboard';
  const GH_FILE_PATH = 'data/report-data.json';
  const GH_BRANCH = 'main';
  const GH_TOKEN_STORAGE_KEY = 'rjn_github_token';

  // ---------- CHANNEL → PLATFORM & ACCOUNT MAPPING ----------
  const CHANNEL_MAPPING = {
    "AJIO_NEW":          { channel: "AJIO",        account: "RAJNANDINI" },
    "AMAZON_FLEX_API":   { channel: "AMAZON",     account: "RAJNANDINI" },
    "AMAZON_IN_API":     { channel: "AMAZON",     account: "RAJNANDINI" },
    "FLIPKART":          { channel: "FLIPKART",   account: "RAJNANDINI" },
    "FLIPKART_ARF":      { channel: "FLIPKART",   account: "ARF" },
    "FLIPKART_SGA":      { channel: "FLIPKART",   account: "SGB" },
    "FLIPKART_SVF":      { channel: "FLIPKART",   account: "SVF" },
    "FLIPKART_VEXIM":    { channel: "FLIPKART",   account: "VIHAAN" },
    "FLIPKART_WW":       { channel: "FLIPKART",   account: "WW" },
    "LIMEROAD":          { channel: "LIMEROAD",   account: "RAJNANDINI" },
    "MEESHO":            { channel: "MEESHO",     account: "RAJNANDINI" },
    "MEESHO_ARF":        { channel: "MEESHO",     account: "ARF" },
    "MEESHO_SGA":        { channel: "MEESHO",     account: "SGB" },
    "MEESHO_SVF":        { channel: "MEESHO",     account: "SVF" },
    "MEESHO_VEXIM":      { channel: "MEESHO",     account: "VIHAAN" },
    "MEESHO_WW":         { channel: "MEESHO",     account: "WW" },
    "Mirraw":            { channel: "MIRRAW",     account: "RAJNANDINI" },
    "MYNTRAPPMP":        { channel: "MYNTRAPPMP", account: "RAJNANDINI" },
    "MYNTRAPPMP-VIHAAN": { channel: "MYNTRAPPMP", account: "VIHAAN" },
    "NYKAA_FASHION_NEW": { channel: "NYKAA",      account: "RAJNANDINI" },
    "RJN_SHOPIFY":       { channel: "WEBSITE",    account: "RAJNANDINI" },
    "snap deal":         { channel: "SNAPDEAL",   account: "RAJNANDINI" },
    "snap deal ":        { channel: "SNAPDEAL",   account: "RAJNANDINI" },
    "SNAPDEAL_WW":       { channel: "SNAPDEAL",   account: "WW" },
    "TATACLIQ":          { channel: "TATACLIQ",   account: "RAJNANDINI" }
  };

  // Sizes from XS to 10XL; anything else → FS (Free Size)
  const SIZE_CODES = new Set([
    "XS","S","M","L","XL","XXL",
    "3XL","4XL","5XL","6XL","7XL","8XL","9XL","10XL"
  ]);

  // Statuses treated as DELIVERED
  const DELIVERED_STATUS_SET = new Set([
    "DISPATCHED",
    "DELIVERED",
    "FULFILLABLE",
    "CREATED",
    "PICKING_FOR_INVOICING"
  ]);

  let rawCsvRows = [];
  let normalizedRows = [];
  let charts = {
    channelRevenueChart: null,
    accountRevenueChart: null,
    stateRevenueChart: null,
    statusChart: null,
    dateRevenueChart: null
  };

  const fileInput       = document.getElementById('fileInput');
  const fileStatus      = document.getElementById('fileStatus');
  const sampleHintBtn   = document.getElementById('sampleHintBtn');
  const generateBtn     = document.getElementById('generateBtn');
  const publishBtn      = document.getElementById('publishBtn');

  const dateRangeInput  = document.getElementById('dateRange');
  const channelFilterEl = document.getElementById('channelFilter');
  const accountFilterEl = document.getElementById('accountFilter');

  const grossRevenueEl  = document.getElementById('grossRevenue');
  const grossUnitsEl    = document.getElementById('grossUnits');
  const totalOrdersEl   = document.getElementById('totalOrders');
  const cancelRateEl    = document.getElementById('cancelRate');

  const githubTokenInput = document.getElementById('githubTokenInput');
  const saveTokenBtn     = document.getElementById('saveTokenBtn');
  const tokenStatusEl    = document.getElementById('tokenStatus');

  const indiaMapTooltip  = document.getElementById('indiaMapTooltip');
  const indiaMapWrapper  = document.getElementById('indiaMapWrapper');
  const indiaMapLegend   = document.getElementById('indiaMapLegend');

  let dateRange = { start: null, end: null };

  // India map state
  let indiaMapLoaded = false;
  let indiaStateElements = [];

  // Init token status
  (function initTokenStatus() {
    const token = localStorage.getItem(GH_TOKEN_STORAGE_KEY);
    tokenStatusEl.textContent = token ? 'Token loaded from this browser.' : 'No token saved yet.';
  })();

  saveTokenBtn.addEventListener('click', () => {
    const token = (githubTokenInput.value || '').trim();
    if (!token) {
      alert('Please paste your GitHub personal access token.');
      return;
    }
    localStorage.setItem(GH_TOKEN_STORAGE_KEY, token);
    tokenStatusEl.textContent = 'Token saved in this browser.';
    githubTokenInput.value = '';
  });

  // Flatpickr (single + range)
  flatpickr(dateRangeInput, {
    mode: "range",
    dateFormat: "Y-m-d",
    onChange: function(selectedDates) {
      if (selectedDates.length === 0) {
        dateRange.start = null;
        dateRange.end = null;
      } else if (selectedDates.length === 1) {
        dateRange.start = selectedDates[0];
        dateRange.end = null;
      } else {
        const [d1, d2] = selectedDates;
        dateRange.start = d1 < d2 ? d1 : d2;
        dateRange.end   = d1 < d2 ? d2 : d1;
      }
      if (normalizedRows.length) applyFiltersAndRender();
    }
  });

  // Load India SVG once on page load
  fetch('assets/india.svg')
    .then(res => {
      if (!res.ok) throw new Error('Failed to load india.svg');
      return res.text();
    })
    .then(svgText => {
      indiaMapWrapper.innerHTML = svgText;
      const svg = indiaMapWrapper.querySelector('svg');
      if (!svg) {
        console.warn('india.svg loaded but no <svg> found.');
        return;
      }
      // select paths with data-name or data-state-name
      indiaStateElements = svg.querySelectorAll('path[data-name], path[data-state-name]');
      indiaMapLoaded = true;
      if (normalizedRows.length) {
        applyFiltersAndRender();
      }
    })
    .catch(err => {
      console.error('Error loading India map:', err);
      indiaMapWrapper.innerHTML = '<div style="font-size:0.8rem;color:#b91c1c;">Could not load India map (assets/india.svg). Check file path.</div>';
    });

  // CSV load
  fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    fileStatus.textContent = `Reading: ${file.name} ...`;

    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      complete: (results) => {
        rawCsvRows = results.data || [];
        fileStatus.textContent = `Loaded ${rawCsvRows.length} rows. Click "Generate Report".`;
        generateBtn.disabled = rawCsvRows.length === 0;
        publishBtn.disabled = true;
      },
      error: (err) => {
        console.error(err);
        fileStatus.textContent = 'Error reading CSV. Check console.';
        rawCsvRows = [];
        normalizedRows = [];
        generateBtn.disabled = true;
        publishBtn.disabled = true;
      }
    });
  });

  sampleHintBtn.addEventListener('click', () => {
    alert(
`Expected minimum columns in CSV:

Shipping Address State
Item SKU Code
Channel Name
Selling Price
Order Date
Sale Order Item Status

Date format example: 01-12-2025 (dd-mm-yyyy)
Selling Price: numeric value (e.g., 460 or 460.50)

Gross Revenue = Sum of Selling Price (all orders)
Gross Units   = Count of rows (each row = 1 unit)

Delivered statuses:
DISPATCHED, DELIVERED, FULFILLABLE, CREATED, PICKING_FOR_INVOICING`
    );
  });

  generateBtn.addEventListener('click', () => {
    normalizedRows = normalizeCsvRows(rawCsvRows);
    fileStatus.textContent = `Normalised ${normalizedRows.length} rows. Adjust filters to slice view.`;
    buildFilterOptions(normalizedRows);
    applyFiltersAndRender();
    publishBtn.disabled = normalizedRows.length === 0;
  });

  publishBtn.addEventListener('click', async () => {
    if (!normalizedRows.length) {
      alert('No normalised data available. Generate report first.');
      return;
    }
    const payload = {
      generated_at: new Date().toISOString(),
      rows: normalizedRows
    };
    await updateReportOnGithub(payload);
  });

  channelFilterEl.addEventListener('change', applyFiltersAndRender);
  accountFilterEl.addEventListener('change', applyFiltersAndRender);

  function parseDateDDMMYYYY(str) {
    if (!str) return null;
    const parts = str.trim().split(/[-\/]/);
    if (parts.length !== 3) return null;
    const [dd, mm, yyyy] = parts.map(p => parseInt(p, 10));
    if (!dd || !mm || !yyyy) return null;
    const month = String(mm).padStart(2, '0');
    const day   = String(dd).padStart(2, '0');
    return `${yyyy}-${month}-${day}`;
  }

  function parseStyleAndSize(skuRaw) {
    const sku = (skuRaw || '').trim();
    if (!sku) {
      return { style_code: '', size: 'FS' };
    }
    const lastDash = sku.lastIndexOf('-');
    let style_code, sizeRaw;
    if (lastDash === -1) {
      style_code = sku;
      sizeRaw = '';
    } else {
      style_code = sku.substring(0, lastDash);
      sizeRaw = sku.substring(lastDash + 1);
    }
    let size = (sizeRaw || '').trim().toUpperCase();
    if (!SIZE_CODES.has(size)) {
      size = 'FS'; // Free Size
    }
    return { style_code, size };
  }

  function normalizeCsvRows(rows) {
    const result = [];
    rows.forEach(row => {
      const state = (row['Shipping Address State'] || row['shipping address state'] || '').trim() || 'Unknown';
      const sku = (row['Item SKU Code'] || row['Item Sku Code'] || row['SKU'] || '').trim();
      const channelNameRaw = (row['Channel Name'] || row['Channel'] || '').trim();
      const priceStr = (row['Selling Price'] || row['selling price'] || '0').toString().replace(/,/g, '').trim();
      const orderDateRaw = (row['Order Date'] || row['order date'] || '').trim();
      const statusRaw = (row['Sale Order Item Status'] || row['Status'] || '').trim();

      const price = parseFloat(priceStr) || 0;
      const dateIso = parseDateDDMMYYYY(orderDateRaw);
      const dateLabel = orderDateRaw || '';

      let platform = 'Unknown';
      let account  = 'Unknown';
      const mapping = CHANNEL_MAPPING[channelNameRaw] || CHANNEL_MAPPING[channelNameRaw.trim()];
      if (mapping) {
        platform = mapping.channel;
        account  = mapping.account;
      } else if (channelNameRaw) {
        platform = channelNameRaw;
      }

      const statusUpper = statusRaw.toUpperCase();
      let logicalStatus;
      if (DELIVERED_STATUS_SET.has(statusUpper)) {
        logicalStatus = 'DELIVERED';
      } else if (statusUpper.includes('CANCEL')) {
        logicalStatus = 'CANCELLED';
      } else if (statusUpper.includes('RETURN')) {
        logicalStatus = 'RETURNED';
      } else {
        logicalStatus = statusUpper || 'UNKNOWN';
      }

      const { style_code, size } = parseStyleAndSize(sku);

      result.push({
        date_iso: dateIso,
        date_label: dateLabel,
        state,
        sku,
        style_code,
        size,
        channel_name_raw: channelNameRaw,
        platform,
        account,
        price,
        status_raw: statusRaw,
        status_logical: logicalStatus
      });
    });
    return result;
  }

  function buildFilterOptions(rows) {
    const platforms = new Set();
    const accounts  = new Set();
    rows.forEach(r => {
      if (r.platform) platforms.add(r.platform);
      if (r.account)  accounts.add(r.account);
    });

    channelFilterEl.innerHTML = '<option value="ALL">All Channels</option>';
    Array.from(platforms).sort().forEach(p => {
      const opt = document.createElement('option');
      opt.value = p;
      opt.textContent = p;
      channelFilterEl.appendChild(opt);
    });

    accountFilterEl.innerHTML = '<option value="ALL">All Accounts</option>';
    Array.from(accounts).sort().forEach(a => {
      const opt = document.createElement('option');
      opt.value = a;
      opt.textContent = a;
      accountFilterEl.appendChild(opt);
    });
  }

  function dateToIsoString(d) {
    if (!d) return null;
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  function applyFiltersAndRender() {
    if (!normalizedRows.length) return;

    const selectedPlatform = channelFilterEl.value || 'ALL';
    const selectedAccount  = accountFilterEl.value || 'ALL';

    const startIso = dateToIsoString(dateRange.start);
    const endIso   = dateToIsoString(dateRange.end);

    const filtered = normalizedRows.filter(r => {
      if (startIso && !endIso) {
        if (!r.date_iso || r.date_iso !== startIso) return false;
      } else if (startIso && endIso) {
        if (!r.date_iso || r.date_iso < startIso || r.date_iso > endIso) return false;
      }
      if (selectedPlatform !== 'ALL' && r.platform !== selectedPlatform) return false;
      if (selectedAccount  !== 'ALL' && r.account  !== selectedAccount)  return false;
      return true;
    });

    fileStatus.textContent = `Filtered rows: ${filtered.length}`;
    processAndRender(filtered);
  }

  function processAndRender(rows) {
    let grossRevenue = 0;
    let grossUnits   = rows.length;
    let totalOrders  = rows.length;
    let cancelledCount = 0;

    const revenueByChannel = {};
    const revenueByAccount = {};
    const revenueByState   = {};
    const statusCounts     = {};
    const revenueByDate    = {};
    const summaryByPlatformAccount = {};

    const priceBuckets = {
      '<500':      { label: '< 500',       orders: 0, revenue: 0 },
      '500-749':   { label: '500 – 749',   orders: 0, revenue: 0 },
      '750-999':   { label: '750 – 999',   orders: 0, revenue: 0 },
      '1000-1499': { label: '1000 – 1499', orders: 0, revenue: 0 },
      '1500+':     { label: '≥ 1500',      orders: 0, revenue: 0 }
    };

    const styleStats = {}; // style_code → { style_code, units, gmv }
    const unitsByState = {};

    rows.forEach(r => {
      const price = r.price || 0;
      grossRevenue += price;

      if (r.status_logical === 'CANCELLED') cancelledCount += 1;

      const statusKey = r.status_logical || 'UNKNOWN';
      statusCounts[statusKey] = (statusCounts[statusKey] || 0) + 1;

      const platform = r.platform || 'Unknown';
      const account  = r.account  || 'Unknown';
      const state    = r.state    || 'Unknown';

      revenueByChannel[platform] = (revenueByChannel[platform] || 0) + price;
      revenueByAccount[account]  = (revenueByAccount[account]  || 0) + price;
      revenueByState[state]      = (revenueByState[state]      || 0) + price;

      unitsByState[state] = (unitsByState[state] || 0) + 1;

      const dateKey = r.date_iso || 'Unknown';
      revenueByDate[dateKey] = (revenueByDate[dateKey] || 0) + price;

      const key = platform + '||' + account;
      if (!summaryByPlatformAccount[key]) {
        summaryByPlatformAccount[key] = { platform, account, revenue: 0, units: 0, orders: 0 };
      }
      summaryByPlatformAccount[key].revenue += price;
      summaryByPlatformAccount[key].units   += 1;
      summaryByPlatformAccount[key].orders  += 1;

      let bucketKey;
      if (price < 500)            bucketKey = '<500';
      else if (price < 750)       bucketKey = '500-749';
      else if (price < 1000)      bucketKey = '750-999';
      else if (price < 1500)      bucketKey = '1000-1499';
      else                        bucketKey = '1500+';

      priceBuckets[bucketKey].orders  += 1;
      priceBuckets[bucketKey].revenue += price;

      if (r.status_logical === 'DELIVERED' && r.style_code) {
        const style = r.style_code;
        if (!styleStats[style]) {
          styleStats[style] = { style_code: style, units: 0, gmv: 0 };
        }
        styleStats[style].units += 1;
        styleStats[style].gmv   += price;
      }
    });

    // Summary cards
    grossRevenueEl.textContent = '₹' + grossRevenue.toLocaleString('en-IN', { maximumFractionDigits: 2 });
    grossUnitsEl.textContent   = grossUnits.toLocaleString('en-IN');
    totalOrdersEl.textContent  = totalOrders.toLocaleString('en-IN');
    const cancelRate = totalOrders ? (cancelledCount / totalOrders) * 100 : 0;
    cancelRateEl.textContent   = cancelRate.toFixed(1) + '%';

    buildChannelRevenueChart(revenueByChannel);
    buildAccountRevenueChart(revenueByAccount);
    buildStateRevenueChart(revenueByState);
    buildStatusChart(statusCounts);
    buildDateRevenueChart(revenueByDate);
    buildChannelTable(summaryByPlatformAccount);
    buildPriceRangeTable(priceBuckets);
    buildTopStylesTable(styleStats);
    updateIndiaMap(revenueByState, unitsByState);
  }

  function destroyChart(chart) {
    if (chart) chart.destroy();
  }

  function buildChannelRevenueChart(revenueByChannel) {
    const ctx = document.getElementById('channelRevenueChart');
    destroyChart(charts.channelRevenueChart);

    const labels = Object.keys(revenueByChannel);
    const data   = labels.map(l => revenueByChannel[l]);

    charts.channelRevenueChart = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: 'Revenue (₹)', data }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (ctx) => '₹' + ctx.raw.toLocaleString('en-IN', { maximumFractionDigits: 2 })
            }
          }
        },
        scales: {
          x: { ticks: { font: { size: 10 }, color: '#4b5563' } },
          y: {
            ticks: {
              color: '#4b5563',
              callback: (val) => '₹' + Number(val).toLocaleString('en-IN')
            }
          }
        }
      }
    });
  }

  function buildAccountRevenueChart(revenueByAccount) {
    const ctx = document.getElementById('accountRevenueChart');
    destroyChart(charts.accountRevenueChart);

    const labels = Object.keys(revenueByAccount);
    const data   = labels.map(l => revenueByAccount[l]);

    charts.accountRevenueChart = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: 'Revenue (₹)', data }] },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (ctx) => '₹' + ctx.raw.toLocaleString('en-IN', { maximumFractionDigits: 2 })
            }
          }
        },
        scales: {
          x: {
            ticks: {
              color: '#4b5563',
              callback: (val) => '₹' + Number(val).toLocaleString('en-IN')
            }
          },
          y: { ticks: { font: { size: 10 }, color: '#4b5563' } }
        }
      }
    });
  }

  function buildStateRevenueChart(revenueByState) {
    const ctx = document.getElementById('stateRevenueChart');
    destroyChart(charts.stateRevenueChart);

    const entries = Object.entries(revenueByState).sort((a, b) => b[1] - a[1]);
    const labels  = entries.map(e => e[0]);
    const data    = entries.map(e => e[1]);

    charts.stateRevenueChart = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: 'Revenue (₹)', data }] },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (ctx) => '₹' + ctx.raw.toLocaleString('en-IN', { maximumFractionDigits: 2 })
            }
          }
        },
        scales: {
          x: {
            ticks: {
              color: '#4b5563',
              callback: (val) => '₹' + Number(val).toLocaleString('en-IN')
            }
          },
          y: { ticks: { font: { size: 10 }, color: '#4b5563' } }
        }
      }
    });
  }

  function buildStatusChart(statusCounts) {
    const ctx = document.getElementById('statusChart');
    destroyChart(charts.statusChart);

    const labels = Object.keys(statusCounts);
    const data   = labels.map(l => statusCounts[l]);

    charts.statusChart = new Chart(ctx, {
      type: 'pie',
      data: { labels, datasets: [{ data }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: { font: { size: 10 }, color: '#4b5563' }
          }
        }
      }
    });
  }

  function buildDateRevenueChart(revenueByDate) {
    const ctx = document.getElementById('dateRevenueChart');
    destroyChart(charts.dateRevenueChart);

    const entries = Object.entries(revenueByDate)
      .filter(([k]) => k && k !== 'Unknown')
      .sort((a, b) => (a[0] > b[0] ? 1 : -1));

    const labels = entries.map(e => e[0]);
    const data   = entries.map(e => e[1]);

    charts.dateRevenueChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Revenue (₹)',
          data,
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (ctx) => '₹' + ctx.raw.toLocaleString('en-IN', { maximumFractionDigits: 2 })
            }
          }
        },
        scales: {
          x: {
            ticks: { maxRotation: 60, minRotation: 30, font: { size: 9 }, color: '#4b5563' }
          },
          y: {
            ticks: {
              color: '#4b5563',
              callback: (val) => '₹' + Number(val).toLocaleString('en-IN')
            }
          }
        }
      }
    });
  }

  function buildChannelTable(summaryByPlatformAccount) {
    const tbody = document.querySelector('#channelTable tbody');
    tbody.innerHTML = '';

    const rows = Object.values(summaryByPlatformAccount)
      .sort((a, b) => b.revenue - a.revenue); // DESC by revenue

    rows.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.platform}</td>
        <td>${r.account}</td>
        <td>₹${r.revenue.toLocaleString('en-IN', { maximumFractionDigits: 2 })}</td>
        <td>${r.units}</td>
        <td>${r.orders}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function buildPriceRangeTable(priceBuckets) {
    const tbody = document.querySelector('#priceRangeTable tbody');
    tbody.innerHTML = '';

    const rows = Object.values(priceBuckets)
      .map(b => ({
        label: b.label,
        orders: b.orders,
        revenue: b.revenue
      }))
      .sort((a, b) => b.orders - a.orders || b.revenue - a.revenue);

    rows.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.label}</td>
        <td>${r.orders.toLocaleString('en-IN')}</td>
        <td>₹${r.revenue.toLocaleString('en-IN', { maximumFractionDigits: 2 })}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function buildTopStylesTable(styleStats) {
    const tbody = document.querySelector('#topStylesTable tbody');
    tbody.innerHTML = '';

    const rows = Object.values(styleStats)
      .sort((a, b) => b.gmv - a.gmv)
      .slice(0, 10);

    rows.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.style_code}</td>
        <td>${r.units.toLocaleString('en-IN')}</td>
        <td>₹${r.gmv.toLocaleString('en-IN', { maximumFractionDigits: 2 })}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ---------- India map update ----------
  function updateIndiaMap(revenueByState, unitsByState) {
    if (!indiaMapLoaded || !indiaStateElements.length) return;

    const revenues = Object.values(revenueByState).filter(v => v > 0);
    const hasData = revenues.length > 0;
    let minRev = 0, maxRev = 0;
    if (hasData) {
      minRev = Math.min(...revenues);
      maxRev = Math.max(...revenues);
    }

    const colors = [
      '#e5edf0', // very light
      '#c7dfe3',
      '#7ab1b9',
      '#2e808b',
      '#013c47'  // darkest
    ];

    function getColor(rev) {
      if (!hasData || rev <= 0) return '#e5e7eb';
      if (minRev === maxRev) return colors[colors.length - 1];
      const t = (rev - minRev) / (maxRev - minRev);
      const idx = Math.max(0, Math.min(colors.length - 1, Math.floor(t * (colors.length))));
      return colors[Math.min(idx, colors.length - 1)];
    }

    // clear any old event handlers tooltip
    indiaStateElements.forEach(el => {
      const name = el.getAttribute('data-name') || el.getAttribute('data-state-name') || '';
      const rev  = revenueByState[name] || 0;
      const units = unitsByState[name] || 0;
      const fillColor = getColor(rev);

      el.style.fill = fillColor;
      el.style.stroke = '#ffffff';
      el.style.strokeWidth = '0.5';

      el.onmouseenter = (evt) => {
        el.style.stroke = '#c9a86a';
        el.style.strokeWidth = '1.2';
        const rect = indiaMapWrapper.getBoundingClientRect();
        const x = evt.clientX;
        const y = evt.clientY;
        indiaMapTooltip.style.left = (x + 10) + 'px';
        indiaMapTooltip.style.top  = (y + 10) + 'px';

        const revStr = '₹' + (rev || 0).toLocaleString('en-IN', { maximumFractionDigits: 2 });
        const unitsStr = (units || 0).toLocaleString('en-IN');

        indiaMapTooltip.innerHTML = `
          <strong>${name || 'Unknown'}</strong><br/>
          Revenue: ${revStr}<br/>
          Units: ${unitsStr}
        `;
        indiaMapTooltip.style.display = 'block';
      };

      el.onmousemove = (evt) => {
        const x = evt.clientX;
        const y = evt.clientY;
        indiaMapTooltip.style.left = (x + 10) + 'px';
        indiaMapTooltip.style.top  = (y + 10) + 'px';
      };

      el.onmouseleave = () => {
        el.style.stroke = '#ffffff';
        el.style.strokeWidth = '0.5';
        indiaMapTooltip.style.display = 'none';
      };
    });

    // Legend
    indiaMapLegend.innerHTML = '';
    const legendLabel = document.createElement('span');
    legendLabel.textContent = 'Higher revenue → darker teal';
    indiaMapLegend.appendChild(legendLabel);

    const blocks = document.createElement('div');
    blocks.className = 'legend-blocks';
    colors.forEach(c => {
      const box = document.createElement('div');
      box.className = 'legend-color';
      box.style.background = c;
      blocks.appendChild(box);
    });
    indiaMapLegend.appendChild(blocks);

    if (hasData) {
      const rangeSpan = document.createElement('span');
      rangeSpan.textContent = `Min: ₹${minRev.toLocaleString('en-IN')}  Max: ₹${maxRev.toLocaleString('en-IN')}`;
      indiaMapLegend.appendChild(rangeSpan);
    } else {
      const noDataSpan = document.createElement('span');
      noDataSpan.textContent = 'No revenue data for current filters.';
      indiaMapLegend.appendChild(noDataSpan);
    }
  }

  async function updateReportOnGithub(payload) {
    const token = localStorage.getItem(GH_TOKEN_STORAGE_KEY);
    if (!token) {
      alert('No GitHub token found. Save your personal access token first.');
      return;
    }

    const url = `https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/contents/${GH_FILE_PATH}`;

    const json = JSON.stringify(payload, null, 2);
    const base64Content = btoa(unescape(encodeURIComponent(json)));

    const headers = {
      'Authorization': `Bearer ${token}`,
      'Accept': 'application/vnd.github+json'
    };

    let sha = undefined;
    try {
      const resGet = await fetch(url, { headers });
      if (resGet.ok) {
        const data = await resGet.json();
        sha = data.sha;
      } else if (resGet.status !== 404) {
        const errText = await resGet.text();
        console.error('GET error', resGet.status, errText);
        alert('Error reading existing report-data.json from GitHub.');
        return;
      }
    } catch (err) {
      console.error(err);
      alert('Network error while reading report-data.json from GitHub.');
      return;
    }

    const body = {
      message: 'Update published report-data.json from admin dashboard',
      content: base64Content,
      branch: GH_BRANCH
    };
    if (sha) {
      body.sha = sha;
    }

    try {
      const resPut = await fetch(url, {
        method: 'PUT',
        headers: {
          ...headers,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
      });

      if (!resPut.ok) {
        const errText = await resPut.text();
        console.error('PUT error', resPut.status, errText);
        alert('Failed to publish report to GitHub. Check console for details.');
        return;
      }

      const data = await resPut.json();
      console.log('Publish success:', data);
      alert('Report published to viewer successfully.\nGitHub Pages will reflect the change shortly.');
    } catch (err) {
      console.error(err);
      alert('Network error while publishing report to GitHub.');
    }
  }
</script>
</body>
</html>
